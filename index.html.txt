<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VOID MARKET | v3.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #020202; color: white; margin: 0; overflow-x: hidden; }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #2563eb; border-radius: 10px; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        @keyframes fade-in { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slide-in-bottom { from { transform: translateY(1rem); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes zoom-in { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        
        .animate-in { animation-duration: 400ms; animation-fill-mode: both; }
        .fade-in { animation-name: fade-in; }
        .slide-in-from-bottom-4 { animation-name: slide-in-bottom; }
        .zoom-in-95 { animation-name: zoom-in; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, deleteDoc, onSnapshot, query, addDoc, orderBy, serverTimestamp, updateDoc, getDoc, limit } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

        window.FB = { initializeApp, getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken, getFirestore, collection, doc, setDoc, deleteDoc, onSnapshot, query, addDoc, orderBy, serverTimestamp, updateDoc, getDoc, limit };
    </script>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // Assets (SVGs)
        const Icons = {
            Package: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M11 21.73a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73z"/><path d="M12 22V12"/><path d="m3.3 7 8.7 5 8.7-5"/><path d="m12 22 8.7-5"/><path d="M12 12.21 3.3 7.21"/><path d="M7.5 4.21 16.5 9.41"/></svg>,
            Trash2: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>,
            X: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>,
            MessageSquare: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>,
            Send: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m22 2-7 20-4-9-9-4Z"/><path d="M22 2 11 13"/></svg>,
            Loader2: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>,
            Copy: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></svg>,
            ShieldCheck: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M20 13c0 5-3.5 7.5-7.66 8.95a1 1 0 0 1-.67-.01C7.5 20.5 4 18 4 13V6a1 1 0 0 1 1-1c2 0 4.5-1.2 6.24-2.72a1.17 1.17 0 0 1 1.52 0C14.51 3.81 17 5 19 5a1 1 0 0 1 1 1z"/><path d="m9 12 2 2 4-4"/></svg>,
            Edit3: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>,
            ArrowLeft: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></svg>,
            Shield: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M20 13c0 5-3.5 7.5-7.66 8.95a1 1 0 0 1-.67-.01C7.5 20.5 4 18 4 13V6a1 1 0 0 1 1-1c2 0 4.5-1.2 6.24-2.72a1.17 1.17 0 0 1 1.52 0C14.51 3.81 17 5 19 5a1 1 0 0 1 1 1z"/></svg>,
            AlertCircle: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></svg>,
            Sparkles: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m12 3 1.912 5.813a2 2 0 0 0 1.275 1.275L21 12l-5.813 1.912a2 2 0 0 0-1.275 1.275L12 21l-1.912-5.813a2 2 0 0 0-1.275-1.275L3 12l5.813-1.912a2 2 0 0 0 1.275-1.275L12 3Z"/><path d="M5 3v4"/><path d="M19 17v4"/><path d="M3 5h4"/><path d="M17 19h4"/></svg>,
            Zap: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>,
            Activity: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>,
            MessageCircle: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M7.9 20A9 9 0 1 0 4 16.1L2 22Z"/></svg>
        };

        const LTC_ADDR = "LWg5qQTocz89GrhkahK6QpLGrBuKcYWm1x";
        const CATEGORIES = ["All", "Accounts", "Software", "Keys", "Discord"];

        function App() {
            const [user, setUser] = useState(null);
            const [products, setProducts] = useState([]);
            const [messages, setMessages] = useState([]); 
            const [adminChats, setAdminChats] = useState([]); 
            const [selectedChatId, setSelectedChatId] = useState(null);
            const [view, setView] = useState('shop'); 
            const [isAdmin, setIsAdmin] = useState(false);
            const [showLoginModal, setShowLoginModal] = useState(false);
            const [loginInput, setLoginInput] = useState("");
            const [showChat, setShowChat] = useState(false);
            const [chatInput, setChatInput] = useState("");
            const [activeCategory, setActiveCategory] = useState('All');

            // Admin states
            const [pId, setPId] = useState("");
            const [pName, setPName] = useState("");
            const [pPrice, setPPrice] = useState("");
            const [pImage, setPImage] = useState("");
            const [pStock, setPStock] = useState("");
            const [pCat, setPCat] = useState("Software");

            // Tx states
            const [selectedProduct, setSelectedProduct] = useState(null);
            const [isVerifying, setIsVerifying] = useState(false);
            const [delivered, setDelivered] = useState(null);
            const [payError, setPayError] = useState(null);
            const chatEndRef = useRef(null);

            useEffect(() => {
                const init = async () => {
                    const { initializeApp, getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken, getFirestore } = window.FB;
                    const firebaseConfig = JSON.parse(window.__firebase_config || "{}");
                    const app = initializeApp(firebaseConfig);
                    const auth = getAuth(app);
                    const db = getFirestore(app);
                    const appId = window.__app_id || 'void-market-v3';

                    if (window.__initial_auth_token) {
                        await signInWithCustomToken(auth, window.__initial_auth_token);
                    } else {
                        await signInAnonymously(auth);
                    }
                    
                    onAuthStateChanged(auth, setUser);
                    window.appDb = db;
                    window.appId = appId;
                };
                init();
            }, []);

            useEffect(() => {
                if (!user || !window.appDb) return;
                const { collection, onSnapshot, doc, query } = window.FB;
                
                const unsubP = onSnapshot(collection(window.appDb, 'artifacts', window.appId, 'public', 'data', 'products'), (s) => {
                    setProducts(s.docs.map(d => {
                        const p = { id: d.id, ...d.data() };
                        if (!isAdmin) delete p.stock; 
                        return p;
                    }));
                });

                const unsubM = onSnapshot(collection(window.appDb, 'artifacts', window.appId, 'users', user.uid, 'messages'), (s) => {
                    setMessages(s.docs.map(d => d.data()).sort((a,b) => a.timestamp?.seconds - b.timestamp?.seconds));
                });

                let unsubAdmin = null;
                if (isAdmin) {
                    unsubAdmin = onSnapshot(collection(window.appDb, 'artifacts', window.appId, 'public', 'data', 'active_chats'), (s) => {
                        setAdminChats(s.docs.map(d => ({ id: d.id, ...d.data() })));
                    });
                }

                return () => { unsubP(); unsubM(); if(unsubAdmin) unsubAdmin(); };
            }, [user, isAdmin]);

            useEffect(() => { if (showChat) chatEndRef.current?.scrollIntoView({ behavior: 'smooth' }); }, [messages, showChat]);

            const handleLogin = async () => {
                const { doc, getDoc, setDoc } = window.FB;
                const master = "VOID-OWNER-ACCESS-HG72dLheif6M";
                try {
                    const secretRef = doc(window.appDb, 'artifacts', window.appId, 'public', 'data', 'secrets', loginInput);
                    const snap = await getDoc(secretRef);
                    if (loginInput === master || (snap.exists() && snap.data().role === 'admin')) {
                        if (!snap.exists()) await setDoc(secretRef, { role: 'admin' });
                        setIsAdmin(true);
                        setView('admin');
                        setShowLoginModal(false);
                        setLoginInput("");
                        setPayError(null);
                    } else { setPayError("INVALID_CREDENTIALS"); }
                } catch (e) { setPayError("NODE_AUTH_FAILURE"); }
            };

            const handleSaveProduct = async () => {
                const { doc, setDoc, serverTimestamp } = window.FB;
                if (!pName || !pPrice) return;
                const id = pId || `p_${Date.now()}`;
                await setDoc(doc(window.appDb, 'artifacts', window.appId, 'public', 'data', 'products', id), {
                    id, name: pName, price: parseFloat(pPrice), category: pCat, image: pImage, stock: pStock, timestamp: serverTimestamp()
                });
                setPId(""); setPName(""); setPPrice(""); setPImage(""); setPStock("");
            };

            const sendMessage = async (recipientId, text, senderRole) => {
                const { collection, addDoc, doc, setDoc, serverTimestamp } = window.FB;
                if (!text.trim() || !recipientId) return;
                await addDoc(collection(window.appDb, 'artifacts', window.appId, 'users', recipientId, 'messages'), {
                    text, sender: senderRole, timestamp: serverTimestamp()
                });
                await setDoc(doc(window.appDb, 'artifacts', window.appId, 'public', 'data', 'active_chats', recipientId), {
                    lastMsg: text, timestamp: serverTimestamp(), userId: recipientId
                });
            };

            const verifyPayment = async () => {
                const { doc, getDoc, updateDoc } = window.FB;
                setIsVerifying(true);
                setPayError(null);
                try {
                    const rateRes = await fetch('https://api.coinbase.com/v2/prices/LTC-EUR/spot');
                    const rateData = await rateRes.json();
                    const targetLtc = selectedProduct.price / parseFloat(rateData.data.amount);
                    const bRes = await fetch(`https://api.blockcypher.com/v1/ltc/main/addrs/${LTC_ADDR}/full?limit=5`);
                    const bData = await bRes.json();
                    const now = Math.floor(Date.now() / 1000);
                    const match = bData.txs?.find(tx => {
                        const txTime = new Date(tx.received).getTime() / 1000;
                        const amount = tx.outputs.find(o => o.addresses.includes(LTC_ADDR))?.value / 100000000;
                        return Math.abs(amount - targetLtc) < (targetLtc * 0.05) && (now - txTime) < 7200;
                    });
                    if (match) {
                        const pRef = doc(window.appDb, 'artifacts', window.appId, 'public', 'data', 'products', selectedProduct.id);
                        const snap = await getDoc(pRef);
                        if (snap.exists() && snap.data().stock?.trim()) {
                            const lines = snap.data().stock.split('\n').filter(l => l.trim());
                            const key = lines[0];
                            await updateDoc(pRef, { stock: lines.slice(1).join('\n') });
                            setDelivered(key); setView('success');
                        } else { setPayError("OUT_OF_STOCK"); }
                    } else { setPayError("TX_NOT_CONFIRMED"); }
                } catch (e) { setPayError("VERIFY_FAILURE"); }
                finally { setIsVerifying(false); }
            };

            return (
                <div className="min-h-screen bg-[#020202] text-white flex flex-col relative overflow-x-hidden">
                    {/* Background */}
                    <div className="fixed inset-0 pointer-events-none">
                        <div className="absolute top-[-10%] left-[-10%] w-[50%] h-[50%] bg-blue-600/5 blur-[120px] rounded-full"></div>
                        <div className="absolute bottom-[-10%] right-[-10%] w-[40%] h-[40%] bg-blue-900/5 blur-[120px] rounded-full"></div>
                    </div>

                    {/* Chat Widget */}
                    {['shop', 'checkout', 'success'].includes(view) && (
                        <div className="fixed bottom-6 right-6 z-[2000] flex flex-col items-end pointer-events-none">
                            {showChat && (
                                <div className="w-[340px] h-[480px] bg-[#0d0d0d] border border-white/10 rounded-[2rem] shadow-2xl flex flex-col overflow-hidden mb-4 pointer-events-auto animate-in slide-in-from-bottom-4 backdrop-blur-xl">
                                    <div className="bg-blue-600 p-5 flex justify-between items-center text-white">
                                        <div className="flex items-center gap-2">
                                            <div className="w-2 h-2 bg-white rounded-full animate-pulse"></div>
                                            <span className="text-[10px] font-black uppercase tracking-widest">Live Support</span>
                                        </div>
                                        <button onClick={() => setShowChat(false)} className="opacity-70 hover:opacity-100"><Icons.X size={18}/></button>
                                    </div>
                                    <div className="flex-1 p-5 overflow-y-auto space-y-4 bg-black/40 custom-scrollbar">
                                        {messages.map((m, i) => (
                                            <div key={i} className={`flex ${m.sender === 'user' ? 'justify-end' : 'justify-start'}`}>
                                                <div className={`p-3.5 rounded-2xl text-[11px] font-semibold max-w-[85%] ${m.sender === 'user' ? 'bg-blue-600 text-white rounded-tr-none' : 'bg-zinc-900 text-zinc-300 rounded-tl-none border border-white/5'}`}>
                                                    {m.text}
                                                </div>
                                            </div>
                                        ))}
                                        <div ref={chatEndRef} />
                                    </div>
                                    <div className="p-3 bg-black border-t border-white/5 flex gap-2">
                                        <input value={chatInput} onChange={e => setChatInput(e.target.value)} onKeyPress={e => e.key === 'Enter' && (sendMessage(user.uid, chatInput, 'user'), setChatInput(''))} placeholder="Message..." className="flex-1 bg-zinc-900 p-3 rounded-xl text-[11px] outline-none border border-white/5 focus:border-blue-600/40 transition-all" />
                                        <button onClick={() => { sendMessage(user.uid, chatInput, 'user'); setChatInput(''); }} className="bg-white text-black px-4 rounded-xl hover:bg-blue-600 hover:text-white transition-all"><Icons.Send size={16}/></button>
                                    </div>
                                </div>
                            )}
                            <button onClick={() => setShowChat(!showChat)} className={`w-14 h-14 rounded-2xl flex items-center justify-center shadow-xl hover:scale-105 active:scale-95 transition-all border border-white/10 pointer-events-auto ${showChat ? 'bg-white text-black' : 'bg-blue-600 text-white shadow-blue-600/20'}`}>
                                {showChat ? <Icons.X size={24}/> : <Icons.MessageSquare size={24}/>}
                            </button>
                        </div>
                    )}

                    {/* Nav */}
                    <nav className="p-6 border-b border-white/5 bg-black/60 backdrop-blur-xl sticky top-0 z-[1000]">
                        <div className="max-w-7xl mx-auto flex justify-between items-center">
                            <div className="flex flex-col">
                                <h1 className="text-2xl font-black italic tracking-tighter cursor-pointer" onClick={() => setView('shop')}>VOID<span className="text-blue-600">MARKET</span></h1>
                                <div className="flex items-center gap-1.5 mt-0.5 opacity-60">
                                    <Icons.Sparkles size={12} className="text-blue-400" />
                                    <span className="text-[7px] font-black uppercase tracking-[0.3em]">Premium Cheap Stuff</span>
                                </div>
                            </div>
                            <div className="flex gap-3 items-center">
                                {isAdmin && (
                                    <button onClick={() => setView('admin')} className={`text-[9px] font-black uppercase px-4 py-2 rounded-lg border border-white/10 transition-all ${view.startsWith('admin') ? 'bg-blue-600 text-black border-transparent' : 'text-zinc-500 hover:text-white'}`}>Terminal</button>
                                )}
                                {!isAdmin && (
                                    <button onClick={() => setShowLoginModal(true)} className="text-[9px] font-black uppercase tracking-widest bg-white text-black px-6 py-2.5 rounded-xl hover:bg-blue-600 hover:text-white transition-all shadow-lg active:scale-95">Admin</button>
                                )}
                            </div>
                        </div>
                    </nav>

                    {/* Categories */}
                    {view === 'shop' && (
                        <div className="w-full bg-black/40 border-b border-white/5 sticky top-[81px] z-[900] backdrop-blur-md overflow-x-auto no-scrollbar">
                            <div className="max-w-7xl mx-auto px-6 py-3.5 flex gap-3 items-center min-w-max">
                                <Icons.Zap size={14} className="text-blue-600"/>
                                {CATEGORIES.map(cat => (
                                    <button 
                                        key={cat} 
                                        onClick={() => setActiveCategory(cat)}
                                        className={`px-5 py-1.5 rounded-full text-[9px] font-black uppercase tracking-widest border transition-all ${activeCategory === cat ? 'bg-blue-600 border-blue-500 text-black shadow-md' : 'bg-zinc-900/40 border-white/5 text-zinc-500 hover:text-white'}`}
                                    >
                                        {cat}
                                    </button>
                                ))}
                            </div>
                        </div>
                    )}

                    <main className="max-w-7xl mx-auto p-6 lg:p-10 w-full flex-1">
                        {view === 'shop' && (
                            <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 animate-in fade-in slide-in-from-bottom-4 duration-500">
                                {products.filter(p => activeCategory === 'All' || p.category === activeCategory).map(p => (
                                    <div key={p.id} className="group flex flex-col bg-[#080808] border border-white/5 p-6 rounded-[2.5rem] hover:border-blue-600/20 transition-all duration-500">
                                        <div className="aspect-square bg-[#030303] rounded-[2rem] mb-6 overflow-hidden flex items-center justify-center border border-white/5 shadow-inner relative group-hover:border-white/10 transition-colors">
                                            {p.image ? (
                                                <img src={p.image} className="w-full h-full object-cover group-hover:scale-110 transition duration-700 opacity-90" />
                                            ) : (
                                                <Icons.Package size={36} className="opacity-10 group-hover:opacity-20 transition duration-500"/>
                                            )}
                                            <div className="absolute top-3 left-3 bg-blue-600 text-white px-2.5 py-0.5 rounded-full text-[7px] font-black uppercase tracking-tighter">Verified</div>
                                        </div>
                                        <div className="mb-6 px-1">
                                            <h3 className="text-lg font-black italic uppercase mb-0.5 tracking-tight truncate">{p.name}</h3>
                                            <p className="text-[8px] font-black text-zinc-600 uppercase tracking-widest">{p.category}</p>
                                        </div>
                                        <div className="mt-auto flex justify-between items-center bg-black/40 p-2.5 rounded-2xl border border-white/5 group-hover:border-blue-600/10 transition-all">
                                            <div className="flex flex-col ml-3">
                                                <span className="text-[7px] font-black text-zinc-500 uppercase">Total</span>
                                                <span className="text-lg font-black italic tracking-tighter text-blue-500">€{p.price}</span>
                                            </div>
                                            <button onClick={() => { setSelectedProduct(p); setView('checkout'); }} className="bg-white text-black px-5 py-2.5 rounded-xl font-black text-[9px] uppercase hover:bg-blue-600 hover:text-white transition-all shadow-md active:scale-95">Buy Now</button>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}

                        {view === 'checkout' && (
                            <div className="max-w-md mx-auto animate-in zoom-in-95">
                                <div className="bg-[#0a0a0a] p-10 rounded-[3rem] border border-white/10 text-center shadow-2xl backdrop-blur-3xl relative overflow-hidden">
                                    <button onClick={() => setView('shop')} className="mb-8 text-[8px] font-black uppercase text-zinc-500 hover:text-white flex items-center gap-2 mx-auto transition-colors tracking-widest"><Icons.ArrowLeft size={14}/> Back to Shop</button>
                                    <div className="mb-10">
                                        <p className="text-[9px] font-black uppercase tracking-[0.3em] text-blue-600 mb-1">Payment Amount</p>
                                        <h2 className="text-5xl font-black italic tracking-tighter">€{selectedProduct?.price}</h2>
                                    </div>
                                    <div className="bg-black/60 p-8 rounded-[2rem] border border-white/5 mb-8 shadow-inner">
                                        <div className="flex items-center justify-center gap-2 mb-4">
                                            <Icons.Activity size={14} className="text-blue-500 animate-pulse"/>
                                            <p className="text-[8px] font-black text-zinc-500 uppercase tracking-widest">LTC Blockchain Address</p>
                                        </div>
                                        <code className="text-[10px] text-zinc-400 font-mono break-all block mb-6 bg-zinc-900/40 p-4 rounded-xl border border-white/10">{LTC_ADDR}</code>
                                        <button onClick={() => {
                                            const el = document.createElement('textarea');
                                            el.value = LTC_ADDR;
                                            document.body.appendChild(el);
                                            el.select();
                                            document.execCommand('copy');
                                            document.body.removeChild(el);
                                        }} className="w-full bg-zinc-900 py-3.5 rounded-xl text-[9px] font-black uppercase border border-white/5 hover:bg-white hover:text-black transition-all flex items-center justify-center gap-2 tracking-widest"><Icons.Copy size={16}/> Copy</button>
                                    </div>
                                    {payError && <div className="mb-6 text-red-500 text-[9px] font-black uppercase flex items-center justify-center gap-2 animate-bounce"><Icons.AlertCircle size={14}/> {payError}</div>}
                                    <button onClick={verifyPayment} disabled={isVerifying} className="w-full bg-blue-600 py-5 rounded-2xl font-black uppercase text-[10px] tracking-[0.2em] text-white hover:bg-white hover:text-black transition-all disabled:opacity-50 active:scale-95">
                                        {isVerifying ? <Icons.Loader2 className="animate-spin mx-auto" size={18}/> : "Confirm Payment"}
                                    </button>
                                </div>
                            </div>
                        )}

                        {view === 'success' && (
                            <div className="max-w-md mx-auto text-center py-20 animate-in zoom-in-95">
                                <div className="w-20 h-20 bg-blue-600/10 rounded-3xl flex items-center justify-center mx-auto mb-8 border border-blue-600/20 shadow-xl">
                                    <Icons.ShieldCheck size={40} className="text-blue-500"/>
                                </div>
                                <h2 className="text-4xl font-black italic uppercase mb-10 tracking-tighter">Decrypted</h2>
                                <div className="bg-zinc-900/40 border border-white/10 p-10 rounded-[2.5rem] mb-10 shadow-xl backdrop-blur-xl">
                                    <p className="text-[8px] font-black text-zinc-600 uppercase mb-4 tracking-widest">Your Code</p>
                                    <code className="text-xl font-black text-blue-400 break-all select-all font-mono block">{delivered}</code>
                                </div>
                                <button onClick={() => setView('shop')} className="text-zinc-600 font-black uppercase text-[9px] flex items-center gap-2 mx-auto hover:text-white transition-all tracking-widest"><Icons.ArrowLeft size={16}/> Nexus Hub</button>
                            </div>
                        )}

                        {isAdmin && view === 'admin' && (
                            <div className="space-y-10 animate-in fade-in duration-500">
                                <div className="grid lg:grid-cols-3 gap-8">
                                    <div className="bg-[#0a0a0a] border border-white/10 p-8 rounded-[2.5rem] space-y-4 h-fit shadow-2xl">
                                        <div className="flex items-center gap-2 mb-4">
                                            <Icons.Edit3 size={18} className="text-blue-600"/>
                                            <h3 className="text-[10px] font-black uppercase tracking-widest">Add Listing</h3>
                                        </div>
                                        <input value={pName} onChange={e => setPName(e.target.value)} placeholder="PRODUCT NAME" className="w-full bg-black/50 border border-white/5 p-4 rounded-xl text-[10px] font-bold outline-none focus:border-blue-600 transition-all" />
                                        <div className="grid grid-cols-2 gap-3">
                                            <input value={pPrice} onChange={e => setPPrice(e.target.value)} placeholder="PRICE (€)" className="w-full bg-black/50 border border-white/5 p-4 rounded-xl text-[10px] font-bold outline-none focus:border-blue-600" />
                                            <select value={pCat} onChange={e => setPCat(e.target.value)} className="w-full bg-black/50 border border-white/5 p-4 rounded-xl text-[10px] font-black uppercase outline-none focus:border-blue-600">
                                                {CATEGORIES.slice(1).map(c => <option key={c} value={c}>{c}</option>)}
                                            </select>
                                        </div>
                                        <input value={pImage} onChange={e => setPImage(e.target.value)} placeholder="IMAGE URL" className="w-full bg-black/50 border border-white/5 p-4 rounded-xl text-[10px] font-bold outline-none focus:border-blue-600" />
                                        <textarea value={pStock} onChange={e => setPStock(e.target.value)} placeholder="STOCK (1 LINE PER ITEM)" rows="5" className="w-full bg-black/50 border border-white/5 p-4 rounded-xl text-[10px] font-mono text-blue-400 outline-none focus:border-blue-600"></textarea>
                                        <button onClick={handleSaveProduct} className="w-full bg-blue-600 text-white py-4 rounded-xl font-black uppercase text-[10px] hover:bg-white hover:text-black transition-all active:scale-95">{pId ? 'Update Listing' : 'Deploy Listing'}</button>
                                        <button onClick={() => setView('admin-chats')} className="w-full bg-zinc-900 text-zinc-500 py-4 rounded-xl font-black uppercase text-[9px] border border-white/5 hover:bg-zinc-800 hover:text-white transition flex items-center justify-center gap-2 tracking-widest"><Icons.MessageCircle size={16}/> Chat Dashboard</button>
                                    </div>
                                    <div className="lg:col-span-2 space-y-3 max-h-[750px] overflow-y-auto pr-2 custom-scrollbar">
                                        {products.map(p => (
                                            <div key={p.id} className="bg-zinc-900/10 border border-white/5 p-6 rounded-3xl flex justify-between items-center group hover:bg-zinc-900/20 transition-all border-l-2 border-l-transparent hover:border-l-blue-600">
                                                <div className="flex items-center gap-6">
                                                    <div className="w-16 h-16 bg-black rounded-2xl border border-white/10 flex items-center justify-center overflow-hidden">
                                                        {p.image ? <img src={p.image} className="w-full h-full object-cover" /> : <Icons.Package size={20} className="opacity-10"/>}
                                                    </div>
                                                    <div>
                                                        <p className="font-black uppercase text-[12px] tracking-tight mb-0.5">{p.name}</p>
                                                        <div className="flex items-center gap-3">
                                                            <span className="text-[10px] font-black text-blue-500 uppercase">€{p.price}</span>
                                                            <span className="text-[9px] font-bold text-zinc-600 uppercase border-l border-white/10 pl-3">Stock: {p.stock?.split('\n').filter(x => x.trim()).length || 0}</span>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div className="flex gap-2">
                                                    <button onClick={() => { setPId(p.id); setPName(p.name); setPPrice(p.price); setPStock(p.stock); setPCat(p.category); setPImage(p.image); }} className="p-3 bg-white/5 text-zinc-500 rounded-xl hover:bg-blue-600 hover:text-white"><Icons.Edit3 size={16}/></button>
                                                    <button onClick={() => window.FB.deleteDoc(window.FB.doc(window.appDb, 'artifacts', window.appId, 'public', 'data', 'products', p.id))} className="p-3 bg-white/5 text-zinc-500 rounded-xl hover:bg-red-600 hover:text-white"><Icons.Trash2 size={16}/></button>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        )}

                        {isAdmin && view === 'admin-chats' && (
                            <div className="grid lg:grid-cols-4 gap-6 h-[700px] animate-in fade-in duration-500">
                                <div className="bg-[#0a0a0a] rounded-[2.5rem] p-6 space-y-3 overflow-y-auto border border-white/10 custom-scrollbar shadow-2xl">
                                    <button onClick={() => setView('admin')} className="w-full mb-6 p-4 rounded-2xl bg-zinc-900 border border-white/5 text-[9px] font-black uppercase flex items-center justify-center gap-2 hover:bg-white hover:text-black transition-all active:scale-95"><Icons.ArrowLeft size={14}/> Dashboard</button>
                                    {adminChats.map(c => (
                                        <button key={c.id} onClick={() => setSelectedChatId(c.id)} className={`w-full p-5 rounded-2xl border transition-all text-left relative group ${selectedChatId === c.id ? 'bg-blue-600 border-transparent text-white shadow-lg' : 'bg-black border-white/5 text-zinc-500 hover:border-white/20'}`}>
                                            <div className="flex justify-between items-start mb-1">
                                                <p className="font-black text-[9px] uppercase truncate">{c.id.substring(0, 15)}</p>
                                                <button onClick={(e) => { e.stopPropagation(); window.FB.deleteDoc(window.FB.doc(window.appDb, 'artifacts', window.appId, 'public', 'data', 'active_chats', c.id)); }} className="opacity-30 hover:opacity-100"><Icons.X size={14}/></button>
                                            </div>
                                            <p className="text-[8px] truncate opacity-70 uppercase font-black">{c.lastMsg || "Transmission..."}</p>
                                        </button>
                                    ))}
                                </div>
                                <div className="lg:col-span-3 bg-[#0a0a0a] rounded-[2.5rem] flex flex-col border border-white/10 overflow-hidden shadow-2xl relative">
                                    {selectedChatId ? (
                                        <AdminMsgView userId={selectedChatId} send={(t) => sendMessage(selectedChatId, t, 'admin')} />
                                    ) : (
                                        <div className="flex-1 flex flex-col items-center justify-center space-y-6 opacity-10">
                                            <Icons.Shield size={64} className="text-blue-500 animate-pulse"/>
                                            <p className="uppercase font-black text-[12px] tracking-[1.5em] text-center ml-[1.5em]">Terminal Ready</p>
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}
                    </main>

                    {/* Modals */}
                    {showLoginModal && (
                        <div className="fixed inset-0 z-[3000] bg-black/90 flex items-center justify-center p-6 backdrop-blur-2xl">
                            <div className="w-full max-w-sm bg-[#0a0a0a] border border-white/10 p-12 rounded-[3.5rem] text-center shadow-2xl animate-in zoom-in-95">
                                <Icons.Shield size={40} className="text-blue-600 mx-auto mb-8 animate-pulse"/>
                                <p className="text-[9px] font-black uppercase text-zinc-500 mb-8 tracking-[0.4em]">Internal Access</p>
                                <input type="password" value={loginInput} onChange={e => setLoginInput(e.target.value)} onKeyPress={e => e.key === 'Enter' && handleLogin()} className="w-full bg-black/50 p-6 rounded-2xl text-center text-3xl font-black mb-8 border border-white/5 outline-none focus:border-blue-600 tracking-widest" autoFocus />
                                {payError && <p className="text-red-500 text-[9px] font-black mb-8 uppercase tracking-widest">{payError}</p>}
                                <button onClick={handleLogin} className="w-full bg-white text-black py-5 rounded-2xl font-black uppercase text-[10px] tracking-widest hover:bg-blue-600 hover:text-white transition-all active:scale-95">Authorize</button>
                                <button onClick={() => { setShowLoginModal(false); setPayError(null); }} className="mt-8 text-[9px] font-black uppercase text-zinc-700 hover:text-zinc-400 transition-colors tracking-widest">Abort</button>
                            </div>
                        </div>
                    )}

                    <footer className="p-8 border-t border-white/5 text-center bg-black/40 backdrop-blur-md opacity-30">
                        <p className="text-[8px] font-black uppercase tracking-[1em] ml-[1em]">Void Market Protocol // v3.0</p>
                    </footer>
                </div>
            );
        }

        function AdminMsgView({ userId, send }) {
            const [history, setHistory] = useState([]);
            const [txt, setTxt] = useState("");
            const end = useRef();
            
            useEffect(() => {
                const { collection, onSnapshot } = window.FB;
                const u = onSnapshot(collection(window.appDb, 'artifacts', window.appId, 'users', userId, 'messages'), (s) => {
                    setHistory(s.docs.map(d => d.data()).sort((a,b) => a.timestamp?.seconds - b.timestamp?.seconds));
                });
                return () => u();
            }, [userId]);
            
            useEffect(() => { end.current?.scrollIntoView({ behavior: 'smooth' }); }, [history]);
            
            const handleSend = () => {
                if (!txt.trim()) return;
                send(txt);
                setTxt('');
            };
            
            return (
                <div className="flex flex-col h-full bg-black/30">
                    <div className="p-6 border-b border-white/5 bg-black/60 flex justify-between items-center">
                        <div className="flex items-center gap-3">
                            <div className="w-2.5 h-2.5 bg-blue-600 rounded-full animate-pulse"></div>
                            <p className="text-[11px] font-black uppercase text-white tracking-widest italic">{userId.substring(0, 16)}</p>
                        </div>
                    </div>
                    <div className="flex-1 p-8 overflow-y-auto space-y-6 custom-scrollbar bg-black/10">
                        {history.map((m, i) => (
                            <div key={i} className={`flex ${m.sender === 'admin' ? 'justify-end' : 'justify-start'}`}>
                                <div className={`p-4 rounded-2xl text-[10px] font-bold max-w-[75%] shadow-xl ${m.sender === 'admin' ? 'bg-white text-black rounded-tr-none' : 'bg-zinc-900 text-zinc-300 rounded-tl-none border border-white/5'}`}>
                                    {m.text}
                                </div>
                            </div>
                        ))}
                        <div ref={end} />
                    </div>
                    <div className="p-6 bg-black/80 border-t border-white/5">
                        <div className="flex gap-3">
                            <input value={txt} onChange={e => setTxt(e.target.value)} onKeyPress={e => e.key === 'Enter' && handleSend()} className="flex-1 bg-zinc-900 p-4 rounded-xl text-[11px] outline-none border border-white/10 focus:border-blue-600/40 transition-all font-bold" placeholder="Compose..." />
                            <button onClick={handleSend} className="bg-blue-600 px-8 rounded-xl text-white font-black uppercase text-[10px] hover:bg-white hover:text-black transition-all active:scale-95"><Icons.Send size={20}/></button>
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

